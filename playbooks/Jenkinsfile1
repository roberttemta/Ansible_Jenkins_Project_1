

pipeline {

    triggers {
        // Schedule to run the job on the 1st day of every month at midnight (00:00)
        cron('H 0 1 * *')
    }

    agent { 

        label 'ansible_master_node' // Label of the Ansible control machine in Jenkins
    }

    environment {
        //ANSIBLE_PLAYBOOK_PATH = "/home/ec2-user/Ansible-dev/play.yml"  // This works hell // Path to the playbook on the Ansible control machine
        ANSIBLE_PLAYBOOK_PATH = 'playbooks/patching.yml'  // Path to the playbook on Github 
        ANSIBLE_INVENTORY_PATH = "/home/ec2-user/Ansible-dev/inv.yml"            // Path to the inventory file on the Ansible control machine
        GIT_BRANCH = 'main'
        GIT_URL = 'https://github.com/roberttemta/Ansible_Jenkins_Project_1.git'
       
    }

    stages {
        stage('Checkout SCM') {
            steps {
                // Optionally check out the code or playbook repository if playbooks are stored in version control
                git branch: "${GIT_BRANCH}", url: "${GIT_URL}"
            }
        }

        stage('Testing Ansible Playbook') {
            steps {
                script {
                    
                    sh """ ansible-playbook -i ${ANSIBLE_INVENTORY_PATH} ${ANSIBLE_PLAYBOOK_PATH} --syntax-check"""
                    
                }
            }
        }
        
        stage('Run Ansible Playbook') {
            steps {
                script {
                    /*
                    sh """" ansible-playbook -i ${ANSIBLE_PLAYBOOK_PATH} -b """
                    */
                    
                    sh """ ansible-playbook -i ${ANSIBLE_INVENTORY_PATH} ${ANSIBLE_PLAYBOOK_PATH} """
                    
                }
            }
        }

       
    }
    
}